---
title: "SUN"
author: "Yueran SUN"
format: html
---

## Setup


```{r}

here::i_am("grades-lab.Rproj")
library(here)
library(tidyverse)
library(ggplot2)

```


## Question 1

```{r}

courses <- read_csv(here("data","courses.csv"))

```

## Question 2


```{r}

sorted_courses <- courses[order(courses$course), ]

column_names_english <- c("Course Name", "Identifier", "Module", "Number of Exams")

knitr::kable(
  sorted_courses, 
  col.names = column_names_english, 
  caption = "Course List"
)

```

## Question 3

```{r}

students <- read_csv(here("data", "students.csv"),
                     col_types = cols(
                       birth_date = col_date(),
                       sex = col_factor()
                     )
)

```


## Question 4

```{r}

grades <- read_delim(here("data", "grades.csv"), 
                     delim = ";",
                     na = "$")

```

## Question 5

```{r}

students |> ggplot()+geom_bar(aes(x = group))

ggsave(here("figures", "question5.png"), 
       width = 6, 
       height = 4)

```

## Question 6 

```{r}

ggplot(students, aes(x = group, fill = sex)) + geom_bar(position = "fill") +
    labs(
    x = "Student Group",
    y = "Number of Students",
    fill = "Gender"
  )

ggsave(here("figures", "question6.png"), 
       width = 6, 
       height = 4)

```

## Question 7

```{r}

library(lubridate)

students|>
  mutate(age = time_length(today() - birth_date, unit="year"))|>
  mutate(age = round(age)) -> students

students |> ggplot()+geom_bar(aes(x = age))


ggsave(here("figures", "question7.png"), 
       width = 6, 
       height = 4)



```

## Question 8 

```{r}

library(knitr)

median_age_by_group <- students |>
  group_by(group) |>
    summarise(
    median_age = round(median(age, na.rm = TRUE)) 
  )

kable(
  median_age_by_group, 
  col.names = c("Group", "Median Age (Years)"), 
  caption = "Median Student Age by Group"
)

#Updating kable did not remove the warning

```

## Question 9 

```{r}

oldest_students <- students |>
  group_by(group) |>
  filter(row_number(desc(age)) == 1) |>
  select(id, sex, age, group) |>
  arrange(desc(age)) |>
  ungroup()

kable(
  oldest_students, 
  col.names = c("Student ID", "Gender", "Age (Years)", "Group"), 
  caption = "Oldest Student in Each Group"
)

```

## Question 10 

The data set contains `r sum(!is.na(grades$grades))` grades.

## Question 11



```{r}

grades_students <- grades|>
  left_join(students, by = "id")

grades_students_courses <- grades_students|>
  left_join(courses, by = "course_id")

grades_students_courses|>
  filter(course == "Warfare and Diplomacy")|>
  group_by(group)|>
  summarize(mean_grade = mean(grade, na.rm = TRUE))|>
  ggplot(aes(x = group, y = mean_grade))+geom_col()


ggsave(here("figures", "question11.png"), 
       width = 6, 
       height = 4)


```

## Question 12

```{r}

grades_students_courses|>
  drop_na()|>
  ggplot(aes(x = as.factor(module), y = grade, fill = as.factor(module))) +
  geom_violin() +
  labs(
    title = "Distribution of Grades Across Modules",
    x = "Module",
    y = "Grades",
    fill = "Module"
  ) 

ggsave(here("figures", "question12.png"), 
       width = 6, 
       height = 4)

```

## Question 13


```{r}

gradesperstudent <- grades_students_courses %>%
  group_by(id, group, sex) %>%
  summarise(
    nb_grades = sum(!is.na(grade)),
    min_grade = min(grade, na.rm = TRUE),
    max_grade = max(grade, na.rm = TRUE),
    avg_grade = mean(grade, na.rm = TRUE),
    median_grade = median(grade, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  select(id, group, sex, nb_grades, min_grade, max_grade, avg_grade, median_grade)

gradesperstudent |>
slice_tail(n = 5) |>
knitr::kable()

```

The summary statistics for the number of grades per student are presented in the table below:

`r gradesperstudent %>% summarise(Minimum = min(nb_grades), Maximum = max(nb_grades), Average = mean(nb_grades), Median = median(nb_grades)) %>% kable(caption = "Summary Statistics for Number of Grades per Student", col.names = c("Minimum Grades", "Maximum Grades", "Average Grades", "Median Grades"), format = "markdown", digits = 2)`

## Question 14

```{r}

ggplot(gradesperstudent, aes(x = nb_grades, fill = sex)) +
  geom_bar(position = "stack") +
  labs(
    title = "Distribution of Number of Grades per Student by Gender",
    x = "Number of Grades",
    y = "Density",
    fill = "Gender"
  )

ggsave(here("figures", "question14.png"), 
       width = 6, 
       height = 4)

```

## Question 15

```{r}

grades_socorg_gov <- grades_students_courses %>%
  filter(course == "Social Organization and Governance") %>%
  group_by(id, group) %>%
  summarise(
    nb_grades_socorg_gov = sum(!is.na(grade)),
    .groups = 'drop'
  )|>
  select(nb_grades_socorg_gov, id, group)

grades_socorg_gov |>
slice_tail(n = 5) |>
knitr::kable()

```

## Question 16

```{r}
grades_distribution_socorg_gov <- grades_socorg_gov %>%
  group_by(nb_grades_socorg_gov) %>%
  summarise(n_students = n(), .groups = 'drop')

grades_distribution_socorg_gov |> 
  ggplot(aes(x = nb_grades_socorg_gov, y = n_students)) +
  geom_col()+
  labs(
    title = "Distribution of Grades Obtained in 'Social Organization and Governance'",
    x = "Number of Grades Obtained per Student",
    y = "Number of Students"
  ) 

ggsave(here("figures", "question16.png"), 
       width = 6, 
       height = 4)

```

## Question 17

```{r}

ggplot(grades_socorg_gov, aes(x = as.factor(group), y = nb_grades_socorg_gov, fill = as.factor(group))) +
  geom_violin() +
  labs(
    title = "Distribution of Grades Count in 'Social Organization and Governance' by Group",
    x = "Student Group",
    y = "Number of Grades Obtained per Student",
    fill = "Group"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

ggsave(here("figures", "question17.png"), 
       width = 6, 
       height = 4)


```

## Question 18 

```{r}

grades_socorg_gov_full <- grades_students_courses %>%
  filter(course == "Social Organization and Governance") %>%
  group_by(id, group, sex) %>%
  summarise(
    nb_grades_socorg_gov = sum(!is.na(grade)),
    .groups = 'drop'
  )

grades_dependency_plot <- ggplot(grades_socorg_gov_full, aes(x = as.factor(group), y = nb_grades_socorg_gov, fill = sex)) +
    geom_violin(position = position_dodge(width = 0.8)) +
    labs(
    title = "Grades Count in 'Social Organization and Governance' by Group and Gender",
    x = "Student Group",
    y = "Number of Grades Obtained per Student",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

ggsave(here("figures", "question18.png"), 
       plot = grades_dependency_plot,
       width = 6, 
       height = 4)


```

## Question 19 

```{r}

student_course_averages <- grades_students_courses %>%
  group_by(id, group, course) %>%
  summarise(
    mean_grade = mean(grade, na.rm = TRUE),
    .groups = 'drop'
  )

student_course_averages_wide <- student_course_averages %>%
  pivot_wider(
    id_cols = c(id, group),
    names_from = course,
    values_from = mean_grade
  )

first_course_col <- names(student_course_averages_wide)[3]
second_course_col <- names(student_course_averages_wide)[4]

student_course_averages_wide %>%
  select(id, group, !!sym(first_course_col), !!sym(second_course_col)) %>%
  head(10) %>%
  kable(caption = "Extract of Student Course Averages (Wide Format)")

```

## Question 20 

```{r}

student_course_averages_wide|>
  ggplot(aes(x = `Astronomy and Celestial Navigation`, y = `Herbalism and Medicine`))+
  geom_jitter()+
  geom_smooth(method = "lm")


ggsave(here("figures", "question20.png"), 
       width = 6, 
       height = 4)


```
## Question 21

```{r}

correlation_by_group <- student_course_averages_wide %>%
  group_by(group) %>%
  summarise(
    correlation_herbalism_tribal = cor(`Herbalism and Medicine`, `Tribal Lore and Traditions`, use = "pairwise.complete.obs"),
    .groups = 'drop'
  )

correlation_by_group %>%
  kable(caption = "Correlation Between Average Grades in Herbalism and Medicine and Tribal Lore and Traditions by Group",
        col.names = c("Group", "Correlation Coefficient"),
        digits = 3)

```

## Question 22


```{r}

student_course_averages_wide |>
  filter(group == 5)|>
  ggplot(aes(x = `Herbalism and Medicine`, y = `Tribal Lore and Traditions`))+
  geom_jitter()+
  geom_smooth(method = "lm")

ggsave(here("figures", "question22.png"), 
       width = 6, 
       height = 4)

  

```

## Question 23 
```{r}

final_grades_df <- student_course_averages_wide %>%
  rowwise() %>%
  mutate(
    final_grade = mean(c_across(3:last_col()), na.rm = TRUE)
  ) %>%
  ungroup() %>%
  select(id, group, final_grade)

final_grades_sex <- final_grades_df %>%
  left_join(
    students %>% select(id, sex),
    by = "id"
  ) %>%
  select(id, group, sex, final_grade) %>%
  arrange(desc(final_grade))

final_grades_sex|>
  head(5) |>
  kable()

```

## Question 24

```{r}

final_grades_sex|>
  ggplot(aes(x = as.factor(group), y = final_grade, fill = as.factor(group))) +
  geom_boxplot() +
  labs(
    title = "Distribution of Final Grades Across Student Groups",
    x = "Student Group",
    y = "Final Grade",
    fill = "Group"
  )

ggsave(here("figures", "question24.png"), 
       width = 6, 
       height = 4)


```
## Question 25    

```{r}

ggplot(final_grades_sex, aes(x = as.factor(group), y = final_grade, fill = as.factor(sex))) +
  geom_boxplot(position = position_dodge(width = 0.8)) +
  labs(
    title = "Distribution of Final Grades by Group and Gender",
    x = "Student Group",
    y = "Final Grade",
    fill = "Gender"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

ggsave(here("figures", "question25.png"), 
       width = 6, 
       height = 4)


```

## Question 26 

```{r}

module_map <- courses %>%
  select(course, module) %>%
  distinct()

condition_1 <- student_course_averages_wide %>%
  rowwise() %>%
  mutate(
    pass_c1 = min(c_across(3:last_col()), na.rm = TRUE) >= 5
  ) %>%
  ungroup() %>%
  select(id, pass_c1)

condition_2 <- student_course_averages_wide %>%
  pivot_longer(
    cols = -c(id, group),
    names_to = "course",
    values_to = "mean_grade"
  ) %>%
  left_join(module_map, by = "course") %>%
  group_by(id, module) %>%
  summarise(
    module_avg = mean(mean_grade, na.rm = TRUE),
    .groups = 'drop_last'
  ) %>%
  summarise(
    pass_c2 = all(module_avg >= 10, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  select(id, pass_c2)

final_pass_status_df <- final_grades_sex %>%
  left_join(condition_1, by = "id") %>%
  left_join(condition_2, by = "id") %>%
  mutate(
    pass = pass_c1 & pass_c2
  ) %>%
  select(id, group, final_grade, pass)

final_pass_status_df %>%
  head(10) %>%
  kable()

```

## Question 27 


```{r}

f <- final_pass_status_df %>%
  filter(pass == FALSE, final_grade >= 10) %>%
  nrow()

f

```

The number of students who failed but have a final grade â‰¥ 10 is 271

## Question 28 

```{r}

pass_rate_by_group <- final_pass_status_df %>%
  group_by(group) %>%
  summarise(
    pass_rate = mean(pass),
    .groups = 'drop'
  )

ggplot(pass_rate_by_group, aes(x = as.factor(group), y = pass_rate, fill = as.factor(group))) +
  geom_col() +
  scale_y_continuous(limits = c(0, 1)) +
  labs(
    title = "Student Pass Rate by Group",
    x = "Student Group",
    y = "Pass Rate (Proportion)",
    fill = "Group"
  )

ggsave(here("figures", "question28.png"), 
       width = 6, 
       height = 4)


```

## Question 29

```{r}

course_failure_responsibility <- student_course_averages_wide %>%
  pivot_longer(
    cols = -c(id, group),
    names_to = "course_name",
    values_to = "average_grade"
  ) %>%
  filter(average_grade < 5) %>%
  group_by(course_name) %>%
  summarise(
    n_failures = n(),
    .groups = 'drop'
  ) %>%
  arrange(desc(n_failures))

most_responsible_course <- course_failure_responsibility %>%
  head(1)

most_responsible_course %>%
  kable()

```

## Question 30 

```{r}


final_status_with_age <- final_pass_status_df %>%
  left_join(
    students %>% select(id, age),
    by = "id"
  )

pass_rate_by_age <- final_status_with_age %>%
  group_by(age) %>%
  summarise(
    pass_rate = mean(pass),
    n_students = n(),
    .groups = 'drop'
  )

pass_rate_by_age|>
  drop_na()|>
  ggplot(aes(x = age, y = pass_rate)) +
  geom_point(aes(size = n_students)) +
  geom_smooth(method = "lm", se = TRUE, color = "blue") +
  scale_y_continuous(limits = c(0, 1)) +
  labs(
    title = "Success Rate as a Function of Student Age",
    x = "Student Age (Years)",
    y = "Pass Rate (Proportion)",
    size = "Number of Students"
  ) 

ggsave(here("figures", "question30.png"), 
       width = 6, 
       height = 4)

```


